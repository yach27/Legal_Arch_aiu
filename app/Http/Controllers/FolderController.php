<?php
namespace App\Http\Controllers;
use App\Models\Folder;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\File;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\DB;

class FolderController extends Controller
{
    private const BASE_PATH = 'd:/legal_office';
    private const DEFAULT_RELATIONS = ['children', 'creator'];

    /**
     * Get all folders (optimized - no relations for faster loading)
     */
    public function index()
    {
        return response()->json(
            Folder::with('creator')
                ->select('folder_id', 'folder_name', 'folder_path', 'folder_type', 'parent_folder_id', 'created_by', 'created_at', 'updated_at')
                ->orderBy('updated_at', 'desc')
                ->get()
        );
    }

    /**
     * Create a new folder (supports subfolders via parent_folder_id)
     */
    public function store(Request $request)
    {
        Log::info('Folder creation attempt', [
            'user' => $request->user()?->getKey(),
            'request_data' => $request->all()
        ]);

        $validated = $request->validate([
            'folder_name' => 'required|string|max:255',
            'folder_path' => 'required|string',
            'folder_type' => 'required|string',
            'parent_folder_id' => 'nullable|integer|exists:folders,folder_id',
        ]);

        $path = $this->buildFolderPath($validated['parent_folder_id'], $validated['folder_name']);

        try {
            DB::beginTransaction();

            // Create physical directory
            if (!File::exists($path)) {
                File::makeDirectory($path, 0755, true);
            }

            $folder = Folder::create([
                'folder_name'       => $validated['folder_name'],
                'folder_path'       => $path,
                'folder_type'       => $validated['folder_type'],
                'parent_folder_id'  => $validated['parent_folder_id'] ?? null,
                'created_by'        => $request->user()->getKey(),
            ]);

            DB::commit();

            Log::info('Folder created successfully', ['folder_id' => $folder->getKey()]);

            return response()->json([
                'message' => 'Folder created successfully',
                'folder'  => $folder->load(self::DEFAULT_RELATIONS)
            ], 201);

        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Folder creation failed', [
                'error' => $e->getMessage(),
                'user_id' => $request->user()?->getKey()
            ]);

            return response()->json([
                'message' => 'Failed to create folder',
                'error' => $e->getMessage()
            ], 500);
        }
    }

    /**
     * Search folders by name or path (optimized)
     */
    public function search(Request $request, $term)
    {
        $folders = Folder::with('creator')
            ->select('folder_id', 'folder_name', 'folder_path', 'folder_type', 'parent_folder_id', 'created_by', 'created_at', 'updated_at')
            ->where(DB::raw('LOWER(folder_name)'), 'LIKE', '%' . strtolower($term) . '%')
            ->orWhere(DB::raw('LOWER(folder_path)'), 'LIKE', '%' . strtolower($term) . '%')
            ->orderBy('updated_at', 'desc')
            ->get();

        return response()->json($folders);
    }

    /**
     * Get recent folders
     */
    public function recent($limit = 5)
    {
        $folders = Folder::orderBy('updated_at', 'desc')
            ->take($limit)
            ->with(self::DEFAULT_RELATIONS)
            ->get();

        return response()->json($folders);
    }

    /**
     * Get single folder with relations
     */
    public function show($id)
    {
        $folder = Folder::with(self::DEFAULT_RELATIONS)->findOrFail($id);
        return response()->json($folder);
    }

    /**
     * Update folder
     */
    public function update(Request $request, $id)
    {
        $folder = Folder::findOrFail($id);

        $validated = $request->validate([
            'folder_name' => 'sometimes|string|max:255',
            'folder_type' => 'sometimes|string',
        ]);

        $folder->update($validated);

        return response()->json($folder->load(self::DEFAULT_RELATIONS));
    }

    /**
     * Delete folder and its physical directory
     */
    public function destroy($id)
    {
        $folder = Folder::findOrFail($id);

        try {
            DB::beginTransaction();

            // Delete physical folder if exists
            if (File::exists($folder->folder_path)) {
                File::deleteDirectory($folder->folder_path);
            }

            $folder->delete();

            DB::commit();

            Log::info('Folder deleted successfully', ['folder_id' => $id]);

            return response()->json(['message' => 'Folder deleted successfully'], 200);

        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Folder deletion failed', [
                'error' => $e->getMessage(),
                'folder_id' => $id
            ]);

            return response()->json([
                'message' => 'Failed to delete folder',
                'error' => $e->getMessage()
            ], 500);
        }
    }

    /**
     * Get folder tree structure (hierarchical display with subfolders)
     */
    public function tree()
    {
        $folders = Folder::with(['children.children', 'creator'])
            ->whereNull('parent_folder_id')
            ->orderBy('folder_name')
            ->get();

        return response()->json($folders);
    }

    /**
     * Get subfolders of a specific folder (optimized)
     */
    public function getSubfolders($parentId)
    {
        Log::info("Getting subfolders for parent_id: {$parentId}");

        $subfolders = Folder::with('creator')
            ->select('folder_id', 'folder_name', 'folder_path', 'folder_type', 'parent_folder_id', 'created_by', 'created_at', 'updated_at')
            ->where('parent_folder_id', $parentId)
            ->orderBy('folder_name')
            ->get();

        // Extra safety: filter out the parent folder itself in case of corrupted data
        $filteredSubfolders = $subfolders->filter(function ($folder) use ($parentId) {
            return $folder->folder_id != $parentId;
        })->values();

        Log::info("Found {$filteredSubfolders->count()} subfolders (after filtering)", [
            'parent_id' => $parentId,
            'folder_ids' => $filteredSubfolders->pluck('folder_id')->toArray()
        ]);

        return response()->json($filteredSubfolders);
    }

    /**
     * Build folder path based on parent folder
     */
    private function buildFolderPath(?int $parentFolderId, string $folderName): string
    {
        if ($parentFolderId) {
            $parent = Folder::findOrFail($parentFolderId);
            return $parent->folder_path . '/' . $folderName;
        }

        return self::BASE_PATH . '/' . $folderName;
    }
}